# **Лабораторная работа «Постреляционное расширение языка**  **SQL**  **на примере**  **PostgreSQL** по дисциплине «Постреляционные базы данных»

## Цель работы:

1. Изучить постреляционные возможности языка SQL.
2. Освоить языки и технологии SQL\PSM.
3. Получить навыки программирования на стороне сервера.

## Средства выполнения:

1. СУБД PostgreSQL
2. PgAdmin

## Литература:

1. Документация PostgreSQL – postgrespro.ru – Документация – PostgeSQL 9.4 – Серверное программирование.
2. Методические рекомендации.

## Время выполнения:

Время выполнения лабораторной работы 4 часа.

## Пункты задания для выполнения:

### **Задание 1** *Базовая часть (удовлетворительно)*

#### **1.1** *Создание и заполнение таблицы*

Через PgAdmin соединиться с PostgreSQL и создать базу данных. В БД создать таблицы по теме своей курсовой работе (или использовать таблицы, созданные ранее), например,

```sql
Clinic(
    num primary key, -- номер – целое  - ключ,
    city varchar not null, -- город  - строковое(varchar), not null
    addr varchar -- адрес  - строковое(varchar)
);
```

```sql
MedPath( --(Направления на лечение), которая cодержит свойства:
    num -- номер направления — целое PK,
    msource --  название клиники, давшей направление— строковое (notnull) FK,
    mdest --  название клиники, куда направляют— строковое (notnull) FK,
    diagnoz -- диагноз,
    fio --ФИО пациента,
    age -- возраст пациента (\&gt;=18),
    dt  -- дата,
    ame  -- цель (консультация, операция, обследование и т.д.),
    prevnum -- номер предыдущего направления — целое FK
);
```

Открыть таблицы на редактирование и заполнить тестовыми данными.

#### **1.2** *Программирование функций  с применением  SQL\PSM*

1) Создать **скалярную функцию** , например,   **minAge** ( клиника ), которая возвращает минимальный возраст пациентов указанной клиники.  Вызвать функцию из окна запроса.

2) Создать **табличную функцию** , например,   **patients** ( клиника ), которая возвращает ФИО, возрас и диагнозы, пациентов в указанной клинике. Вызвать функцию из окна запроса.

3) Создать **хранимую процедуру** (с перехватом и вызовом исключений, проверки условия и выполнением запрросов к таблицам), например, **Send1medCons** (клиника, фио, диагноз, возраст = 18), которая проверяет наличие клиники. Если ее не существует, то вызывает исключение. Иначе создает направление в ГКБ-1 с текущей датой на консультацию. Перехват исключений на вставку. Вызвать процедуру из окна запроса. Проверить перехват и создание исключений.

### **Задание 2** Расширенная часть (хорошо)

#### **2.1** *Извлечение части записей и результатов запросов на изменение данных*

Продемонстрировать выполнение запроса на получение первых 3-х записей из результата (**limit**).

Продемонстрировать выполнение запроса на добавление/изменение данных с отображением измененных строк (**returning**).

#### **2.2** *Выполнение рекурсивных запросов*

Продемонстрировать выполнение рекурсивного запроса, например, перечень клиник, где были пациенты ГКБ 67.

#### **2.3** *Создание динамических запросов*

Создать хранимую процедуру с динамическим запросом, например, **copy_patients** (клиника, диапазон), которая выполняет:

- Если таблица с именем клиники (из входного параметра) не существует, то создать ее с полями (fio,age,diagnoz,ame);
- Очистить таблицу и добавить в нее пациентов клиники для указанного диапазона.

Вызвать процедуру из окна запроса.

### **Задание 3** Дополнительное задание (отлично):

#### **3.1** *Выполнение ранжирующих запросов*

Продемонстрировать выполнение функций **row_number()**, **Rank()**, **dense_rank()**, **ntile(4)**.

#### **3.2** *Программирование функции - агрегата*

Создать функцию-агрегат, например, **MaxMin()**, которая применяется к целым числам и возвращает соотношение максимальных и минимальных значений. Проверить работоспособность функции из окна запроса

#### **3.3** *Создание DDL триггера*

Создать DDL триггер (например, на удаление таблиц, начинающихся с SYS), который пишет в журнал сведения о событии и делает откат транзакции. Проверить работу триггера.

## Вопросы для самопроверки:

1. Каковы возможности программирования на стороне сервера с применением SQL\PSM?
2. Хранимые процедуры и функции (скалярные, in-line). Их синтаксис и способы вызова. Передача параметров. Параметры по умолчанию.
3. Конструкции языка SQL-PSM: условие, перехват исключений, создание исключений, присваивание переменных.
4. Синтаксис и процесс выполнения рекурсивных запросов.
5. Синтаксис и назначение ранжирующих функций.
6. Постреляционные возможности языка SQL.
7. Как создать, собрать, присоединить и вызвать функцию агрегат? Каковы ее методы?
8. Что такое DML триггер, как и когда он запускается и как его создать? Как из триггера определить изменяемые данные?
9. Что такое динамические запросы? Как их выполнять?
10. Что такое DDL триггер, как и когда он запускается и как его создать? Как из триггера определить возникшее событие и его параметры?

## В отчет:

1. Тексты SQL сценариев (создание объектов БД), запросов, команд и процедур.
2. Результаты выполнения запросов (скриншоты).